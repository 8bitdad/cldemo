user opscode opscode;
worker_processes 2;
error_log /var/log/opscode/nginx/error.log;

daemon off;

events {
  worker_connections 10240;
}

http {
  log_format opscode '$remote_addr - $remote_user [$time_local]  '
                    '"$request" $status "$request_time" $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" "$upstream_addr" "$upstream_status" "$upstream_response_time" "$http_x_chef_version" "$http_x_ops_sign" "$http_x_ops_userid" "$http_x_ops_timestamp" "$http_x_ops_content_hash" $request_length';

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;

  keepalive_timeout 65;

  gzip on;
  gzip_http_version 1.0;
  gzip_comp_level 2;
  gzip_proxied any;
  gzip_types text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript application/json;

  include /opt/opscode/embedded/conf/mime.types;

  lua_package_path "/var/opt/opscode/nginx/etc/scripts/?.lua;$prefix/?.lua;;";
  lua_shared_dict maint_data 1m;
  lua_shared_dict banned_ips 1m;

  # Preload some shared modules globally
  init_by_lua '
    redis = require("resty/redis")
    config = require("config")
    routes = require("routes")
    resolver = require("resolver")
    route_checks = require("route_checks")

    config.set_maint_refresh_interval(600)
    config.set_ban_refresh_interval(600)
    config.set_default_org(false)
  ';

  upstream opscode_erchef {
    server 127.0.0.1:8000;
  }
  upstream oc_bifrost {
    server 127.0.0.1:9463;
  }
  upstream opscode_solr4 {
    server 127.0.0.1:8983;
  }
  upstream bookshelf {
    server 127.0.0.1:4321;
  }

  # Include upstream definitions for addons
  include /var/opt/opscode/nginx/etc/addon.d/*_upstreams.conf;

  fastcgi_temp_path "/var/opt/opscode/nginx/tmp/fastcgi";
  client_body_temp_path "/var/opt/opscode/nginx/tmp/client_body";
  uwsgi_temp_path "/var/opt/opscode/nginx/tmp/uwsgi";
  scgi_temp_path "/var/opt/opscode/nginx/tmp/scgi";

  # external lb config for Chef API
    proxy_cache_path  /var/opt/opscode/nginx/cache/webui levels=1:2 keys_zone=webui-cache:50m max_size=5000m inactive=600m;
    proxy_cache_path  /var/opt/opscode/nginx/cache/cookbooks levels=1:2 keys_zone=cookbooks:50m max_size=5000m inactive=600m;
    proxy_temp_path /var/opt/opscode/nginx/cache-tmp;

  # We support three options: serve nothing on non_ssl_port (80),
  # redirect to https, or actually serve the API.

  # We support three options: serve nothing on non_ssl_port (80),
  # redirect to https, or actually serve the API.
        server {
          listen 81;
          access_log /var/log/opscode/nginx/rewrite-port-81.log;
          return 301 https://$host$request_uri;
        }
        # Chef HTTPS API
        include /var/opt/opscode/nginx/etc/chef_https_lb.conf;

      # internal lb config for Chef API Services
      server {
        listen 9680;
        # The name doesn't matter; this is the only listener on this port
        server_name wbench.lab.local;

        client_max_body_size 250m;
        proxy_set_header        Host            $host;
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto http;
        proxy_set_header        X-Forwarded-Host $http_host;
        proxy_pass_request_headers on;
        proxy_connect_timeout   90;
        proxy_send_timeout      90;
        proxy_read_timeout      90;

        access_log /var/log/opscode/nginx/internal-chef.access.log opscode;
        error_log  /var/log/opscode/nginx/internal-chef.error.log;

        # Include internal routes for addons
        include /var/opt/opscode/nginx/etc/addon.d/*_internal.conf;

        location "/" {
          set $upstream "";
          set $mode "internal_chef";
          rewrite_by_lua_file '/var/opt/opscode/nginx/etc/scripts/dispatch.lua';

          proxy_redirect http://$upstream /;
          proxy_pass http://$upstream;
        }
      }

      # internal service access for oc_bifrost
      server {
        listen 9683;
        server_name wbench.lab.local;

        client_max_body_size 250m;
        proxy_set_header        Host            $host;
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto http;
        proxy_set_header        X-Forwarded-Host $http_host;
        proxy_pass_request_headers on;

        proxy_connect_timeout   90;
        proxy_send_timeout      90;
        proxy_read_timeout      90;

        access_log /var/log/opscode/nginx/internal-authz.access.log opscode;
        error_log  /var/log/opscode/nginx/internal-authz.error.log;

        location / {
          proxy_pass http://oc_bifrost;
        }
      }

      include /var/opt/opscode/nginx/etc/nginx.d/*.conf;
    }
